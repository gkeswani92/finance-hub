<h1 class="text-2xl font-bold tracking-tight text-gray-900 mb-6">Import</h1>

<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
  <h3 class="text-sm font-semibold text-gray-900 mb-4">Kubera CSV Import</h3>
  <p class="text-sm text-gray-500 mb-6">Upload a CSV export from Kubera to import your accounts and balances.</p>

  <%= form_with(url: "/import/parse", method: :post, multipart: true) do %>
    <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-gray-400 transition-colors">
      <svg class="w-10 h-10 text-gray-300 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
      </svg>
      <input type="file" name="file" accept=".csv" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-gray-900 file:text-white file:cursor-pointer hover:file:bg-gray-800">
    </div>
    <div class="mt-4">
      <input type="submit" value="Parse CSV" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-800 cursor-pointer transition-colors">
    </div>
  <% end %>
</div>

<% if @parsed.present? %>
  <div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h3 class="text-sm font-semibold text-gray-900 mb-4">Parsed Accounts (<%= @parsed.size %>)</h3>

    <%= form_with(url: "/import/execute", method: :post) do %>
      <input type="hidden" name="accounts_data" value="<%= @parsed.to_json %>">

      <% sheets = @parsed.map { |p| p[:sheet] }.compact.uniq %>
      <% sections = @parsed.map { |p| p[:section] }.compact.uniq %>

      <% if sheets.any? %>
        <div class="mb-6">
          <h4 class="text-xs font-semibold text-gray-500 uppercase mb-2">Map Sheets to Members</h4>
          <div class="space-y-2">
            <% sheets.each do |sheet| %>
              <div class="flex items-center gap-3">
                <span class="text-sm text-gray-700 w-32"><%= sheet %></span>
                <select name="mappings[members][<%= sheet %>]" class="rounded-lg border-gray-300 shadow-sm text-sm focus:ring-teal-500 focus:border-teal-500">
                  <option value="">Skip</option>
                  <% @members.each do |m| %>
                    <option value="<%= m.id %>" <%= m.name == sheet ? "selected" : "" %>><%= m.name %></option>
                  <% end %>
                </select>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if sections.any? %>
        <div class="mb-6">
          <h4 class="text-xs font-semibold text-gray-500 uppercase mb-2">Map Sections to Asset Types</h4>
          <div class="space-y-2">
            <% sections.each do |section| %>
              <div class="flex items-center gap-3">
                <span class="text-sm text-gray-700 w-32"><%= section %></span>
                <select name="mappings[categories][<%= section %>]" class="rounded-lg border-gray-300 shadow-sm text-sm focus:ring-teal-500 focus:border-teal-500">
                  <option value="">Skip</option>
                  <% @categories.each do |c| %>
                    <option value="<%= c.id %>" <%= c.name.downcase == section.downcase ? "selected" : "" %>><%= c.name %></option>
                  <% end %>
                </select>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Preview Table -->
      <div class="overflow-x-auto mb-4">
        <table class="w-full divide-y divide-gray-100 text-sm">
          <thead>
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Sheet</th>
              <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Section</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Value (USD)</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Currency</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-50">
            <% @parsed.first(20).each do |row| %>
              <tr>
                <td class="px-4 py-2 text-gray-900"><%= row[:name] %></td>
                <td class="px-4 py-2 text-gray-500"><%= row[:sheet] %></td>
                <td class="px-4 py-2 text-gray-500"><%= row[:section] %></td>
                <td class="px-4 py-2 text-right text-gray-900"><%= format_currency(row[:value_usd]) %></td>
                <td class="px-4 py-2 text-right text-gray-500"><%= row[:currency] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <input type="submit" value="Import Accounts" class="bg-gray-900 text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-gray-800 cursor-pointer transition-colors">
    <% end %>
  </div>
<% end %>
