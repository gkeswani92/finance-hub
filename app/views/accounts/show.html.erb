<div class="p-8">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-900 tracking-tight"><%= @account.name %></h2>
      <p class="text-sm text-gray-400 mt-1">
        <%= @account.owner.name %> &middot; <%= @account.category.name %> &middot; <%= @account.institution %>
      </p>
    </div>
    <div class="flex gap-3">
      <%= link_to "Edit", edit_account_path(@account), class: "text-sm text-teal-600 hover:text-teal-700" %>
      <%= link_to "Back", accounts_path, class: "text-sm text-gray-400 hover:text-gray-600" %>
    </div>
  </div>

  <!-- Current Value -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-8">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs font-medium uppercase tracking-wider text-gray-400">Current Value</p>
        <p class="text-4xl font-bold tracking-tight text-gray-900 mt-2">
          <%= format_currency(@account.latest_value, @account.currency) %>
        </p>
        <% if @account.currency != "USD" %>
          <p class="text-sm text-gray-400 mt-1">
            <%= format_currency(@account.latest_value_usd, "USD") %> USD
          </p>
        <% end %>
      </div>

      <% if @account.cost_basis && @account.cost_basis > 0 %>
        <div class="text-right">
          <p class="text-xs font-medium uppercase tracking-wider text-gray-400">Return</p>
          <% gain = @account.latest_value - @account.cost_basis %>
          <% gain_pct = (gain / @account.cost_basis) * 100 %>
          <p class="mt-2">
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-sm font-bold <%= gain >= 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-600' %>">
              <%= format("%+.1f%%", gain_pct) %>
            </span>
          </p>
          <p class="text-sm mt-1 <%= gain >= 0 ? 'text-emerald-600' : 'text-red-500' %>">
            <%= format_currency(gain.abs, @account.currency) %> <%= gain >= 0 ? "gain" : "loss" %>
          </p>
        </div>
      <% end %>
    </div>

    <% if @account.cost_basis && @account.cost_basis > 0 %>
      <div class="mt-4 pt-4 border-t border-gray-100 flex gap-8">
        <div>
          <p class="text-xs font-medium uppercase tracking-wider text-gray-400">Cost Basis</p>
          <p class="text-sm font-medium text-gray-900 mt-0.5">
            <%= format_currency(@account.cost_basis, @account.currency) %>
          </p>
        </div>
        <div>
          <p class="text-xs font-medium uppercase tracking-wider text-gray-400">CAGR</p>
          <p class="text-sm font-medium mt-0.5 <%= @account.cagr && @account.cagr >= 0 ? 'text-emerald-600' : @account.cagr ? 'text-red-500' : 'text-gray-900' %>">
            <%= @account.cagr_display %>
          </p>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Record New Value -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-8">
    <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-4">Record Value</h3>
    <%= form_with(model: [@account, ValueSnapshot.new], url: account_snapshots_path(@account)) do |f| %>
      <div class="flex gap-4 items-end">
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Date</label>
          <%= f.date_field :snapshot_date, value: Date.current, class: "rounded-lg border-gray-300 shadow-sm text-sm focus:ring-teal-500 focus:border-teal-500" %>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Value (<%= @account.currency %>)</label>
          <%= f.number_field :value, step: 0.01, class: "rounded-lg border-gray-300 shadow-sm text-sm focus:ring-teal-500 focus:border-teal-500", required: true %>
        </div>
        <%= f.submit "Save", class: "bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-teal-700 cursor-pointer transition-colors" %>
      </div>
    <% end %>
  </div>

  <!-- Value History Chart -->
  <% if @snapshots.any? %>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-4">Value History</h3>
      <div data-controller="account-history-chart"
           data-account-history-chart-data-value='<%= @snapshots.map { |s| { date: s.snapshot_date.to_s, value: s.value.to_f } }.to_json %>'
           class="h-64">
        <div data-account-history-chart-target="canvas"></div>
      </div>
    </div>
  <% end %>

  <!-- Snapshot Table -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-100">
      <thead>
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Date</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase">Value</th>
          <% if @account.currency != "USD" %>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase">USD Value</th>
          <% end %>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-50">
        <% @snapshots.each do |snapshot| %>
          <tr class="hover:bg-gray-50/50 transition-colors">
            <td class="px-6 py-4 text-sm text-gray-900"><%= snapshot.snapshot_date.strftime("%b %d, %Y") %></td>
            <td class="px-6 py-4 text-sm text-right font-medium text-gray-900">
              <%= format_currency(snapshot.value, @account.currency) %>
            </td>
            <% if @account.currency != "USD" %>
              <td class="px-6 py-4 text-sm text-right text-gray-500">
                <% fx_rate = ExchangeRate.latest("USD", "INR")&.rate || 85.0 %>
                <%= format_currency(snapshot.value / fx_rate, "USD") %>
              </td>
            <% end %>
          </tr>
        <% end %>
        <% if @snapshots.empty? %>
          <tr>
            <td colspan="<%= @account.currency != 'USD' ? 3 : 2 %>" class="px-6 py-8 text-center text-gray-400">No snapshots yet.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
