<div class="p-8">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-900 tracking-tight">
        <%= @account.name %>
        <% unless @account.is_active %>
          <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">Archived</span>
        <% end %>
      </h2>
    </div>
    <div class="flex gap-3 items-center">
      <% if @account.is_active %>
        <%= button_to "Archive", account_path(@account), method: :delete, class: "text-sm text-red-500 hover:text-red-600 font-medium cursor-pointer", data: { turbo_confirm: "Archive this account? It will be hidden from active lists but its history will be preserved." } %>
      <% else %>
        <%= button_to "Unarchive", unarchive_account_path(@account), method: :patch, class: "text-sm text-teal-600 hover:text-teal-700 font-medium cursor-pointer" %>
      <% end %>
      <%= link_to "Back", accounts_path, class: "text-sm text-gray-400 hover:text-gray-600" %>
    </div>
  </div>

  <!-- Current Value -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-8">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs font-medium uppercase tracking-wider text-gray-400">Current Value</p>
        <p class="text-4xl font-bold tracking-tight text-gray-900 mt-2">
          <%= format_currency(@account.latest_value, @account.currency) %>
        </p>
        <% if @account.currency != "USD" %>
          <p class="text-sm text-gray-400 mt-1">
            <%= format_currency(@account.latest_value_usd, "USD") %> USD
          </p>
        <% end %>
      </div>

      <% if @account.cost_basis && @account.cost_basis > 0 %>
        <div class="text-right">
          <p class="text-xs font-medium uppercase tracking-wider text-gray-400">Return</p>
          <% gain = @account.latest_value - @account.cost_basis %>
          <% gain_pct = (gain / @account.cost_basis) * 100 %>
          <p class="mt-2">
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-sm font-bold <%= gain >= 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-600' %>">
              <%= format("%+.1f%%", gain_pct) %>
            </span>
          </p>
          <p class="text-sm mt-1 <%= gain >= 0 ? 'text-emerald-600' : 'text-red-500' %>">
            <%= format_currency(gain.abs, @account.currency) %> <%= gain >= 0 ? "gain" : "loss" %>
          </p>
        </div>
      <% end %>
    </div>

    <% if @account.cost_basis && @account.cost_basis > 0 %>
      <div class="mt-4 pt-4 border-t border-gray-100 flex gap-8">
        <div>
          <p class="text-xs font-medium uppercase tracking-wider text-gray-400">Cost Basis</p>
          <p class="text-sm font-medium text-gray-900 mt-0.5">
            <%= format_currency(@account.cost_basis, @account.currency) %>
          </p>
        </div>
        <div>
          <p class="text-xs font-medium uppercase tracking-wider text-gray-400">CAGR</p>
          <p class="text-sm font-medium mt-0.5 <%= @account.cagr && @account.cagr >= 0 ? 'text-emerald-600' : @account.cagr ? 'text-red-500' : 'text-gray-900' %>">
            <%= @account.cagr_display %>
          </p>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Account Details -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-8">
    <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-4">Account Details</h3>
    <%= form_with(model: @account, class: "space-y-6") do |f| %>
      <% if @account.errors.any? %>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <ul class="list-disc list-inside text-sm text-red-600">
            <% @account.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Name</label>
          <%= f.text_field :name, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm", required: true %>
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Institution</label>
          <%= f.text_field :institution, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Owner</label>
          <%= f.collection_select :owner_id, @owners, :id, :name, { prompt: "Select owner" }, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Category</label>
          <%= f.collection_select :category_id, @categories, :id, :name, { prompt: "Select category" }, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Currency</label>
          <%= f.select :currency, [["USD ($)", "USD"], ["INR (â‚¹)", "INR"]], {}, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Cost Basis</label>
          <%= f.number_field :cost_basis, step: 0.01, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
        </div>
      </div>

      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Notes</label>
        <%= f.text_area :notes, rows: 3, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
      </div>

      <div>
        <%= f.submit "Save", class: "bg-teal-600 text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-teal-700 cursor-pointer transition-colors" %>
      </div>
    <% end %>
  </div>

  <!-- Value History Chart -->
  <% if @snapshots.any? %>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-8">
      <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-400 mb-4">Value History</h3>
      <div data-controller="account-history-chart"
           data-account-history-chart-data-value='<%= @snapshots.map { |s| { date: s.snapshot_date.to_s, value: s.value.to_f } }.to_json %>'
           class="h-64">
        <div data-account-history-chart-target="canvas"></div>
      </div>
    </div>
  <% end %>

  <!-- Snapshot Table -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-100">
      <thead>
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Date</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase">Value</th>
          <% if @account.currency != "USD" %>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase">USD Value</th>
          <% end %>
          <th class="px-6 py-3"></th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-50">
        <!-- Record new value row -->
        <tr class="bg-gray-50/50">
          <%= form_with(model: [@account, ValueSnapshot.new], url: account_snapshots_path(@account)) do |f| %>
            <td class="px-6 py-3">
              <%= f.date_field :snapshot_date, value: Date.current, class: "rounded-lg border-gray-300 shadow-sm text-sm focus:ring-teal-500 focus:border-teal-500" %>
            </td>
            <td class="px-6 py-3 text-right">
              <%= f.number_field :value, step: 0.01, placeholder: @account.currency, class: "rounded-lg border-gray-300 shadow-sm text-sm focus:ring-teal-500 focus:border-teal-500 w-32 text-right", required: true %>
            </td>
            <% if @account.currency != "USD" %>
              <td class="px-6 py-3"></td>
            <% end %>
            <td class="px-6 py-3 text-right">
              <%= f.submit "Save", class: "bg-teal-600 text-white px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-teal-700 cursor-pointer transition-colors" %>
            </td>
          <% end %>
        </tr>
        <% @snapshots.each do |snapshot| %>
          <tr class="hover:bg-gray-50/50 transition-colors">
            <td class="px-6 py-4 text-sm text-gray-900"><%= snapshot.snapshot_date.strftime("%b %d, %Y") %></td>
            <td class="px-6 py-4 text-sm text-right font-medium text-gray-900">
              <%= format_currency(snapshot.value, @account.currency) %>
            </td>
            <% if @account.currency != "USD" %>
              <td class="px-6 py-4 text-sm text-right text-gray-500">
                <% fx_rate = ExchangeRate.latest("USD", "INR")&.rate || 85.0 %>
                <%= format_currency(snapshot.value / fx_rate, "USD") %>
              </td>
            <% end %>
            <td class="px-6 py-4"></td>
          </tr>
        <% end %>
        <% if @snapshots.empty? %>
          <tr>
            <td colspan="<%= @account.currency != 'USD' ? 4 : 3 %>" class="px-6 py-8 text-center text-gray-400">No snapshots yet.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
