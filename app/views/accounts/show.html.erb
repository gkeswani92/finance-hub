<div class="mb-6">
  <%= link_to accounts_path, class: "inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700 transition-colors" do %>
    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
    </svg>
    Back to Accounts
  <% end %>
</div>

<div class="flex items-start justify-between mb-6">
  <div>
    <h1 class="text-2xl font-bold tracking-tight text-gray-900">
      <%= @account.name %>
      <% unless @account.is_active %>
        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">Archived</span>
      <% end %>
    </h1>
    <div class="flex items-center gap-3 mt-1">
      <%= member_badge(@account.member) %>
      <% if @account.institution.present? %>
        <span class="text-sm text-gray-500"><%= @account.institution %></span>
      <% end %>
      <span class="text-sm text-gray-400"><%= @account.category&.name %></span>
    </div>
  </div>
  <div class="flex gap-3 items-center">
    <% if @account.is_active %>
      <%= button_to "Archive", account_path(@account), method: :delete, class: "text-sm text-red-500 hover:text-red-600 font-medium cursor-pointer", data: { turbo_confirm: "Archive this account?" } %>
    <% else %>
      <%= button_to "Unarchive", unarchive_account_path(@account), method: :patch, class: "text-sm text-teal-600 hover:text-teal-700 font-medium cursor-pointer" %>
    <% end %>
  </div>
</div>

<!-- 3 Summary Cards -->
<div class="grid grid-cols-1 gap-4 sm:grid-cols-3 mb-6">
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
    <p class="text-xs font-medium text-gray-500 mb-1">Current Value</p>
    <p class="text-2xl font-bold tracking-tight text-gray-900"><%= format_currency(@account.latest_value, @account.currency) %></p>
    <% if @account.currency != "USD" %>
      <p class="text-xs text-gray-400 mt-0.5"><%= format_currency(@account.latest_value_usd, "USD") %> USD</p>
    <% end %>
    <% if @snapshots.size >= 2 %>
      <% prev = @snapshots.second %>
      <% change = @account.latest_value - prev.value %>
      <% change_pct = prev.value.zero? ? 0 : (change / prev.value * 100) %>
      <p class="text-xs font-medium mt-2 <%= change_color_class(change) %>">
        <%= change >= 0 ? '+' : '' %><%= format_currency(change.abs, @account.currency) %>
        (<%= format("%+.1f%%", change_pct) %>)
      </p>
    <% end %>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
    <p class="text-xs font-medium text-gray-500 mb-1">Cost Basis</p>
    <% if @account.cost_basis && @account.cost_basis > 0 %>
      <p class="text-2xl font-bold tracking-tight text-gray-900"><%= format_currency(@account.cost_basis, @account.currency) %></p>
      <% gain = @account.latest_value - @account.cost_basis %>
      <% gain_pct = (gain / @account.cost_basis) * 100 %>
      <p class="text-xs font-medium mt-2 <%= change_color_class(gain) %>">
        Return: <%= format("%+.1f%%", gain_pct) %> (<%= format_currency(gain.abs, @account.currency) %>)
      </p>
    <% else %>
      <p class="text-2xl font-bold tracking-tight text-gray-300">--</p>
    <% end %>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
    <p class="text-xs font-medium text-gray-500 mb-1">Snapshots</p>
    <p class="text-2xl font-bold tracking-tight text-gray-900"><%= @snapshots.size %></p>
    <% if @account.cagr %>
      <p class="text-xs font-medium mt-2 <%= change_color_class(@account.cagr) %>">
        CAGR: <%= @account.cagr_display %>
      </p>
    <% end %>
  </div>
</div>

<!-- Value History Chart -->
<% if @snapshots.size >= 2 %>
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
    <h3 class="text-sm font-semibold text-gray-900 mb-4">Value History</h3>
    <div data-controller="account-history-chart"
         data-account-history-chart-data-value='<%= @snapshots.map { |s| { date: s.snapshot_date.to_s, value: s.value.to_f } }.to_json %>'
         class="h-64">
      <div data-account-history-chart-target="canvas"></div>
    </div>
  </div>
<% end %>

<!-- Record Value Form -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
  <h3 class="text-sm font-semibold text-gray-900 mb-4">Record Value</h3>
  <%= form_with(model: [@account, ValueSnapshot.new], url: account_snapshots_path(@account), class: "flex items-end gap-3") do |f| %>
    <div>
      <label class="block text-xs font-medium text-gray-500 mb-1">Date</label>
      <%= f.date_field :snapshot_date, value: Date.current, class: "rounded-lg border-gray-300 shadow-sm text-sm focus:ring-teal-500 focus:border-teal-500" %>
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-500 mb-1">Value (<%= @account.currency %>)</label>
      <%= f.number_field :value, step: 0.01, class: "rounded-lg border-gray-300 shadow-sm text-sm focus:ring-teal-500 focus:border-teal-500 w-36 text-right", required: true %>
    </div>
    <%= f.submit "Save", class: "bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-800 cursor-pointer transition-colors" %>
  <% end %>
</div>

<!-- Snapshot History Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
  <table class="w-full divide-y divide-gray-100">
    <thead>
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Value</th>
        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Change</th>
        <th class="px-6 py-3 w-16"></th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-50">
      <% @snapshots.each_with_index do |snapshot, i| %>
        <% prev_snapshot = @snapshots[i + 1] %>
        <% change = prev_snapshot ? snapshot.value - prev_snapshot.value : nil %>
        <% change_pct = prev_snapshot && prev_snapshot.value > 0 ? (change / prev_snapshot.value * 100) : nil %>
        <tr class="hover:bg-gray-50/50 transition-colors">
          <td class="px-6 py-3 text-sm text-gray-900"><%= snapshot.snapshot_date.strftime("%b %d, %Y") %></td>
          <td class="px-6 py-3 text-sm text-right font-medium text-gray-900"><%= format_currency(snapshot.value, @account.currency) %></td>
          <td class="px-6 py-3 text-sm text-right">
            <% if change %>
              <span class="<%= change_color_class(change) %>"><%= format("%+.1f%%", change_pct) %></span>
            <% else %>
              <span class="text-gray-300">--</span>
            <% end %>
          </td>
          <td class="px-6 py-3 text-right">
            <%= button_to account_snapshot_path(@account, snapshot), method: :delete, class: "text-gray-400 hover:text-red-500 transition-colors cursor-pointer", data: { turbo_confirm: "Delete this snapshot?" } do %>
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
              </svg>
            <% end %>
          </td>
        </tr>
      <% end %>
      <% if @snapshots.empty? %>
        <tr>
          <td colspan="4" class="px-6 py-8 text-center text-gray-400 text-sm">No snapshots yet.</td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<!-- Account Details -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-6">
  <h3 class="text-sm font-semibold text-gray-900 mb-4">Account Details</h3>
  <%= form_with(model: @account, class: "space-y-4") do |f| %>
    <% if @account.errors.any? %>
      <div class="bg-red-50 border border-red-200 rounded-lg p-3">
        <ul class="list-disc list-inside text-sm text-red-600">
          <% @account.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Name</label>
        <%= f.text_field :name, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm", required: true %>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Institution</label>
        <%= f.text_field :institution, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Member</label>
        <%= f.collection_select :member_id, @members, :id, :name, { prompt: "Select member" }, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Category</label>
        <%= f.collection_select :category_id, @categories, :id, :name, { prompt: "Select category" }, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Currency</label>
        <%= f.select :currency, [["USD ($)", "USD"], ["INR (â‚¹)", "INR"]], {}, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Cost Basis</label>
        <%= f.number_field :cost_basis, step: 0.01, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
      </div>
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-500 mb-1">Notes</label>
      <%= f.text_area :notes, rows: 2, class: "w-full rounded-lg border-gray-300 shadow-sm focus:ring-teal-500 focus:border-teal-500 text-sm" %>
    </div>
    <%= f.submit "Save Changes", class: "bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-800 cursor-pointer transition-colors" %>
  <% end %>
</div>
